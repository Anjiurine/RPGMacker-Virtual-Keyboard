window.reineXdRs_VirtualButtons?"off"in reineXdRs_VirtualButtons.getURL()?reineXdRs_VirtualButtons.VB_Manager.changeVisible(!1):reineXdRs_VirtualButtons.VB_Manager.changeVisible(!0):(window.reineXdRs_VirtualButtons={getURL:function getURL(){for(var obj={imgPath:"img/system/",opacity:60,visible:!0,coexistTouch:!0,rockerX:20,rockerY:450,rockerDiam:160,rockerFix:!0,ballLimit:!1,keyA:'{"x":"590","y":"540","width":"86","height":"56","value":"90","text":"A"}',keyB:'{"x":"700","y":"540","width":"86","height":"56","value":"88","text":"B"}',invalidScenes:""},scripts=document.getElementsByTagName("script"),script=document.currentScript||scripts[scripts.length-1],url=script.src.split("?").slice(1).join("?"),k=url.split("&"),i=0;i<k.length;i++)try{var p=k[i].split("="),l=p.slice(0,1)[0],r=p.slice(1).join("=");if("_base64"==l){obj=eval("("+decodeURIComponent(escape(atob(r.replace(/\s+/g,""))))+")");break}l&&(obj[l]=decodeURIComponent(r))}catch(t){}return obj}},function(isMZ){var parameters=reineXdRs_VirtualButtons.getURL();CanvasRenderingContext2D.prototype.setRoundRectPath=function(t,e,i){this.beginPath(0),this.arc(t-i,e-i,i,0,Math.PI/2),this.lineTo(i,e),this.arc(i,e-i,i,Math.PI/2,Math.PI),this.lineTo(0,i),this.arc(i,i,i,Math.PI,3*Math.PI/2),this.lineTo(t-i,0),this.arc(t-i,i,i,3*Math.PI/2,2*Math.PI),this.lineTo(t,e-i),this.closePath()},Bitmap.prototype.fillRoundRect=function(t,e,i,a,s,o,n,r){if(!(2*s>i||2*s>a)){var h=this._context;h.save(),h.translate(t,e),h.setRoundRectPath(i,a,s),h.lineWidth=o||2,h.strokeStyle=n||"black",r&&(h.fillStyle=r,h.fill()),h.stroke(),h.restore()}},Bitmap.prototype.drawCircleGD=function(t,e,i,a,s,o){var n=this._context,r=n.createRadialGradient(t,e,i,t,e,i*a);n.beginPath(),n.arc(t,e,i,0,2*Math.PI,!0),n.closePath(),r.addColorStop(0,s),r.addColorStop(1,o),n.fillStyle=r,n.fill(),n.restore()},Bitmap.prototype.clearCircle=function(t,e,i){var a=this._context;a.save(),a.beginPath(),a.arc(t,e,i,0,2*Math.PI,!1),a.clip(),a.clearRect(t-i,e-i,2*i,2*i),a.restore()},Bitmap.prototype.drawArrow=function(t,e,i,a,s,o){var n="up"===o?t+i/2:t,r="left"===o?e+a/2:e,h="right"===o?e+a/2:"up"===o?e+a:e,c="left"===o?t+i:"down"===o?t+i/2:t,p=this._context;p.beginPath(),p.moveTo(n,r),p.lineTo(t+i,h),p.lineTo(c,e+a),p.lineTo(n,r),p.closePath(),p.fillStyle=s,p.fill(),p.stroke(),p.restore()},Bitmap.prototype.setImageData=function(t){t&&this._context.putImageData(t,0,0)},isMZ&&(Bitmap.prototype.adjustTone=function(t,e,i){if((t||e||i)&&this.width>0&&this.height>0){for(var a=this._context,s=a.getImageData(0,0,this.width,this.height),o=s.data,n=0;n<o.length;n+=4)o[n+0]+=t,o[n+1]+=e,o[n+2]+=i;a.putImageData(s,0,0),this._baseTexture.update()}});var TouchInput_onLeftButtonDown=TouchInput._onLeftButtonDown;TouchInput._onLeftButtonDown=function(t){var e=Graphics.pageToCanvasX(t.pageX),i=Graphics.pageToCanvasY(t.pageY);!VB_Manager.isHover(e,i)&&TouchInput_onLeftButtonDown.call(this,t)},TouchInput._onTouchStart=function(t){for(var e=0;e<t.changedTouches.length;e++){var i=t.changedTouches[e],a=Graphics.pageToCanvasX(i.pageX),s=Graphics.pageToCanvasY(i.pageY);Graphics.isInsideCanvas(a,s)&&!VB_Manager.isHover(a,s)&&(this._screenPressed=!0,this._pressedTime=0,t.touches.length>=2?this._onCancel(a,s):this._onTrigger(a,s),t.preventDefault())}(window.cordova||window.navigator.standalone)&&t.preventDefault()},TouchInput._onTouchMove=function(t){for(var e=0;e<t.changedTouches.length;e++){var i=t.changedTouches[e],a=Graphics.pageToCanvasX(i.pageX),s=Graphics.pageToCanvasY(i.pageY);!VB_Manager.isHover(a,s)&&this._onMove(a,s)}};var XR_TouchInput_update=TouchInput.update;if(TouchInput.update=function(){VB_Manager.isCoexistTouch()&&XR_TouchInput_update.call(this)},!isMZ){var XR_StorageManager_localFilePath=StorageManager.localFilePath;StorageManager.localFilePath=function(t){return"virtualButton"===t?this.localFileDirectoryPath()+VB_Manager.dataFileName()+".rpgsave":XR_StorageManager_localFilePath.call(this,t)};var XR_StorageManager_webStorageKey=StorageManager.webStorageKey;StorageManager.webStorageKey=function(t){return"virtualButton"===t?"RPG "+VB_Manager.dataFileName():XR_StorageManager_webStorageKey.call(this,t)}}ImageManager.loadVbImg=function(t){return this.loadBitmap(parameters.imgPath,t)};var XR_SceneManager_changeScene=SceneManager.changeScene;SceneManager.changeScene=function(){var t=this._scene?this._scene.constructor:null;XR_SceneManager_changeScene.call(this),this._scene&&t!==this._scene.constructor&&VB_Manager.onSceneChange(this._scene.constructor)};var XR_SceneManager_updateInputData=SceneManager.updateInputData;if(SceneManager.updateInputData=function(){XR_SceneManager_updateInputData.call(this),VB_Manager.update()},isMZ)PluginManager.registerCommand(pluginName,"ChangeVbVisible",function(args){VB_Manager.changeVisible(!!eval(args.state))}),PluginManager.registerCommand(pluginName,"OpenVbDebug",function(){SceneManager.push(Scene_DebugVB)});else{var XR_Game_Interpreter_pluginCommand=Game_Interpreter.prototype.pluginCommand;Game_Interpreter.prototype.pluginCommand=function(t,e){XR_Game_Interpreter_pluginCommand.call(this,t,e),"ChangeVbVisible"===t&&VB_Manager.changeVisible("ON"===e[0].toUpperCase()),"OpenVbDebug"===t&&SceneManager.push(Scene_DebugVB)}}if(Graphics._canvas)setTimeout(function(){VB_Manager.initialize()},0);else{var XR_Scene_Boot_start=Scene_Boot.prototype.start;Scene_Boot.prototype.start=function(){XR_Scene_Boot_start.call(this),VB_Manager.initialize()}}function VB_Manager(){throw new Error("This is a static class")}function VB_PartBase(){this.initialize.apply(this,arguments)}function VB_Rocker(){this.initialize.apply(this,arguments)}function VB_Button(){this.initialize.apply(this,arguments)}VB_Manager.initialize=function(){document.body.parentNode.style.overflowX="hidden",document.body.parentNode.style.overflowY="hidden",this._buttons=[],this._requestImgs=[],this._isSceneVisible=!0,this._isImgRequested=!1,this._isVisible=!!eval(parameters.visible),this.setupBaseData(),this.loadSaveData()},VB_Manager.dataFileName=function(){return"VirtualButtons"},VB_Manager.setupBaseData=function(){var _this=this,requestImgs=[];this._baseData={buttons:{}},this._baseData.opacity=parseInt(parameters.opacity)/100,this._baseData.coexistTouch=!!eval(parameters.coexistTouch);var rd=parseInt(parameters.rockerDiam)||160,rx=Math.max(0,Math.min(Graphics.width-rd,parseInt(parameters.rockerX)||0)),ry=Math.max(0,Math.min(Graphics.height-rd,parseInt(parameters.rockerY)||0));this._baseData.buttons.rocker={},this._baseData.buttons.rocker.se=parameters.seName,this._baseData.buttons.rocker.img=parameters.rockerImg,this._baseData.buttons.rocker.ballImg=parameters.ballImg,this._baseData.buttons.rocker.rect=new Rectangle(rx,ry,rd,rd),this._baseData.buttons.rocker.isFixed=!!eval(parameters.rockerFix),this._baseData.buttons.rocker.ballLimit=!!eval(parameters.ballLimit),requestImgs.push(parameters.rockerImg),requestImgs.push(parameters.ballImg),["A","B","C","D","E"].forEach(function(t){var e="key"+t;if(parameters[e]){var i=JSON.parse(parameters[e]);if(i.value){var a=parseInt(i.width)||0,s=parseInt(i.height)||0,o=Math.max(0,Math.min(Graphics.width-a,parseInt(i.x)||0)),n=Math.max(0,Math.min(Graphics.height-s,parseInt(i.y)||0));(i.img||a>=30&&s>=30)&&(requestImgs.push(i.img),_this._baseData.buttons[e]={},_this._baseData.buttons[e].se=i.se,_this._baseData.buttons[e].img=i.img,_this._baseData.buttons[e].text=i.text,_this._baseData.buttons[e].rect=new Rectangle(o,n,a,s),_this._baseData.buttons[e].keyCode=parseInt(i.value))}}}),this._requestImgs=requestImgs.filter(function(t){return!!t}),this.startRequestImgs()},VB_Manager.loadSaveData=function(){var t=this;if(this._saveData=null,isMZ)StorageManager.loadObject(this.dataFileName()).then(function(e){t.onSaveDataLoad(e)}).catch(function(){t.onSaveDataLoad(null)});else{var e=StorageManager.load("virtualButton");this.onSaveDataLoad(e?JSON.parse(e):null)}},VB_Manager.startRequestImgs=function(){var t=this;this._requestImgs.length>0?this._requestImgs.forEach(function(e){ImageManager.loadVbImg(e).addLoadListener(function(){t.onImgRequested(e)})}):this.onRequestImgsEnd()},VB_Manager.onImgRequested=function(t){var e=this._requestImgs.indexOf(t);this._requestImgs.splice(e,1),0===this._requestImgs.length&&this.onRequestImgsEnd()},VB_Manager.onRequestImgsEnd=function(){this._isImgRequested=!0,this.isSaveDataLoaded()&&this.createButtons()},VB_Manager.onSaveDataLoad=function(t){this._saveData=t||{empty:!0},this._isImgRequested&&this.createButtons()},VB_Manager.onSceneChange=function(sceneClass){if(this.isReady()){var arr=parameters.invalidScenes.split(","),result=arr.some(function(text){var scene=null;try{scene=eval(text)}catch(t){console.error("【虚拟按键插件】 不显示虚拟按键的场景参数设置错误 => ("+text+") ？！")}return scene&&scene===sceneClass});this.changeSceneVisible(!result)}},VB_Manager.isSaveDataLoaded=function(){return!!this._saveData},VB_Manager.isReady=function(){return this._isImgRequested&&this.isSaveDataLoaded()},VB_Manager.isEnabled=function(){return this.isReady()&&this._isVisible&&this._isSceneVisible},VB_Manager.isCoexistTouch=function(){return!this.isEnabled()||!this._baseData||this._baseData.buttons.rocker.isFixed&&this._baseData.coexistTouch},VB_Manager.createButtons=function(){var t=this,e=!!this._saveData.empty,i=this[e?"_baseData":"_saveData"].opacity;Object.keys(this._baseData.buttons).forEach(function(a){var s=null;!e&&t._saveData.buttons[a]&&(s=t._saveData.buttons[a]);var o=t._baseData.buttons[a];s&&(o.rect.x=s.x,o.rect.y=s.y);var n=new("rocker"===a?VB_Rocker:VB_Button)(a,o,i);t._buttons.push(n)}),this.refreshButtonsVisible()},VB_Manager.resetSaveData=function(t){var e=this;this._saveData=t;var i=this._saveData.opacity;Object.keys(this._saveData.buttons).forEach(function(t){var a=e._saveData.buttons[t];a&&e._buttons.forEach(function(e){e.name()===t&&e.reset(a.x,a.y,i)})}),isMZ?StorageManager.saveObject(this.dataFileName(),this._saveData):StorageManager.save("virtualButton",JSON.stringify(this._saveData))},VB_Manager.changeVisible=function(t){this.isReady()&&this._isVisible!==t&&(this._isVisible=t,this.refreshButtonsVisible())},VB_Manager.changeSceneVisible=function(t){this.isReady()&&this._isSceneVisible!==t&&(this._isSceneVisible=t,this.refreshButtonsVisible())},VB_Manager.refreshButtonsVisible=function(){var t=this._isVisible&&this._isSceneVisible;this._buttons.forEach(function(e){return e.changeVisible(t)})},VB_Manager.getDebugData=function(){var t=this,e={buttons:{}},i=!!this._saveData.empty;return e.opacity=this[i?"_baseData":"_saveData"].opacity,Object.keys(this._baseData.buttons).forEach(function(a){var s=t._baseData.buttons[a].rect,o=new Point(s.x,s.y);!i&&t._saveData.buttons[a]&&(o=t._saveData.buttons[a]),e.buttons[a]=o}),e},VB_Manager.getDebugImgs=function(){var t={},e=this._baseData.buttons.rocker.isFixed;return this._buttons.forEach(function(i){("rocker"!==i.name()||e)&&(t[i.name()]=i.makeDebugData())}),t},VB_Manager.isHover=function(t,e){return this.isEnabled()&&this._buttons.some(function(i){return i.isTouch(t,e)})},VB_Manager.isHoverButton=function(t,e){return!!this.isEnabled()&&this._buttons.some(function(i){return"rocker"!==i.name()&&i.isTouch(t,e)})},VB_Manager.update=function(){this.isEnabled()&&this._buttons.forEach(function(t){return t.update()})},VB_PartBase.prototype.constructor=VB_PartBase,VB_PartBase.prototype.initialize=function(t,e,i){this._name=t,this._data=e,this._lastScale=1,this._isVisible=!0,this._rect=e.rect,this._currentKeys=[],this._opacity=i,this.clear(),this.createBitmap(),this.setupEventHandlers()},VB_PartBase.prototype.clear=function(){this._isPressed=!1,this._identifier=null,this.clearPressedKeys()},VB_PartBase.prototype.clearPressedKeys=function(){this.keyUp(...this._currentKeys),this._currentKeys=[]},VB_PartBase.prototype.name=function(){return this._name},VB_PartBase.prototype.playSe=function(){if(this._data.se){var t=ConfigManager.seVolume,e={name:this._data.se,volume:t,pitch:100,pan:0};AudioManager.playSe(e)}},VB_PartBase.prototype.keyDown=function(){var t=this;Array.prototype.forEach.call(arguments,function(e){e&&!t._currentKeys.contains(e)&&(Input._onKeyDown(t.createInputEvent(e)),t._currentKeys.push(e))})},VB_PartBase.prototype.keyUp=function(){var t=this;Array.prototype.forEach.call(arguments,function(e){if(t._currentKeys.contains(e)){Input._onKeyUp(t.createInputEvent(e));var i=t._currentKeys.indexOf(e);t._currentKeys.splice(i,1)}})},VB_PartBase.prototype.createInputEvent=function(t){var e={};return e.keyCode=t,e.preventDefault=function(){},e},VB_PartBase.prototype.createBitmap=function(){this._data.img?(this._bitmap=this.createPictureBitmap(this._data.img),this._rect.width=this._bitmap.width,this._rect.height=this._bitmap.height):(this._bitmap=new Bitmap(this._rect.width,this._rect.height),this.drawBitmap()),this.setupBitmap()},VB_PartBase.prototype.createPictureBitmap=function(t){var e=ImageManager.loadVbImg(t),i=e.width,a=e.height,s=new Bitmap(i,a);return s.blt(e,0,0,i,a,0,0),s},VB_PartBase.prototype.drawBitmap=function(){var t=this._bitmap.width,e=this._bitmap.height,i=Math.floor(t/2),a="rgba(255,255,255,0.5)";if("rocker"===this._name){var s=.9*i,o=.6*i,n=t/5;this._bitmap.drawCircleGD(i,i,i,.95,"rgb(120,120,120)","rgb(20,20,20)"),this._bitmap.drawCircleGD(i,i,s,.8,"rgb(20,20,20)","rgb(120,120,120)"),this._bitmap.drawCircleGD(i,i,o,.4,"rgb(80,80,80)","rgb(0,0,0)"),this._bitmap.drawArrow(t/2-n/2,i-o,n,n,a,"up"),this._bitmap.drawArrow(i-o,t/2-n/2,n,n,a,"left"),this._bitmap.drawArrow(t-o-n/2,t/2-n/2,n,n,a,"right"),this._bitmap.drawArrow(t/2-n/2,t-o-n/2,n,n,a,"down"),this._bitmap.clearCircle(i,i,i/3-4)}else this._bitmap.fillRoundRect(6,6,t-12,e-12,10,6,"rgb(0,0,0)"),this._bitmap.clearRect(0,0,t,e-12),this._bitmap.fillRoundRect(5,5,t-10,e-12,10,4,"rgb(0,0,0)","rgb(80,80,80)"),this._data.text&&(this._bitmap.fontSize=e-24,this._bitmap.drawText(this._data.text,6,6,t-12,e-15,"center"))},VB_PartBase.prototype.setupBitmap=function(){var t=this._bitmap.canvas;t.id=this._name,t.style.position="absolute",t.style.margin="auto",t.style.zIndex=97,this.onWindowResize(),this.onOpacityChange(),document.body.appendChild(t)},VB_PartBase.prototype.setupEventHandlers=function(){document.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mousemove",this.onMouseMove.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),document.addEventListener("touchstart",this.onTouchStart.bind(this)),document.addEventListener("touchmove",this.onTouchMove.bind(this)),document.addEventListener("touchend",this.onTouchEnd.bind(this))},VB_PartBase.prototype.setOpacity=function(t){this._opacity!==t&&(this._opacity=t,this.onOpacityChange())},VB_PartBase.prototype.changeVisible=function(t){this._isVisible!==t&&(this._isVisible=t,!t&&this.clear(),this.onOpacityChange())},VB_PartBase.prototype.onOpacityChange=function(){if(this._bitmap){var t=this.isVisible()?this._opacity:0;this._bitmap.canvas.style.opacity=t}},VB_PartBase.prototype.isVisible=function(){return this._isVisible},VB_PartBase.prototype.isCurrentTouch=function(t){return t&&this._identifier===t.identifier},VB_PartBase.prototype.onMouseDown=function(t){if(this._isVisible&&0===t.button){var e=Graphics.pageToCanvasX(t.pageX),i=Graphics.pageToCanvasY(t.pageY);Graphics.isInsideCanvas(e,i)&&this.isTouch(e,i)&&this.onTouch(e,i)}},VB_PartBase.prototype.onMouseMove=function(t){if(this._isVisible&&0===t.button&&this._isPressed){var e=Graphics.pageToCanvasX(t.pageX),i=Graphics.pageToCanvasY(t.pageY);this.isTouch(e,i)?this.onTouchChange(e,i):this.onRelease()}},VB_PartBase.prototype.onMouseUp=function(t){this._isVisible&&0===t.button&&this._isPressed&&this.onRelease()},VB_PartBase.prototype.onTouchStart=function(t){if(this._isVisible){for(var e=0;e<t.changedTouches.length;++e){var i=t.changedTouches[e],a=Graphics.pageToCanvasX(i.pageX),s=Graphics.pageToCanvasY(i.pageY);Graphics.isInsideCanvas(a,s)&&this.isTouch(a,s)&&(this.onTouch(a,s,i),t.preventDefault())}(window.cordova||window.navigator.standalone)&&t.preventDefault()}},VB_PartBase.prototype.onTouchMove=function(t){if(this._isVisible&&this._isPressed)for(var e=0;e<t.changedTouches.length;++e){var i=t.changedTouches[e];if(this.isCurrentTouch(i)){var a=Graphics.pageToCanvasX(i.pageX),s=Graphics.pageToCanvasY(i.pageY);this.isTouch(a,s)?this.onTouchChange(a,s):this.onRelease()}}},VB_PartBase.prototype.onTouchEnd=function(t){if(this._isVisible&&this._isPressed)for(var e=0;e<t.changedTouches.length;++e){var i=t.changedTouches[e];this.isCurrentTouch(i)&&this.onRelease()}},VB_PartBase.prototype.isTouch=function(t,e){return this._isVisible&&this._rect&&this._rect.contains(t,e)},VB_PartBase.prototype.onTouch=function(t,e,i){this._isPressed||(this._isPressed=!0,this.playSe(),this.keyDown(this._data.keyCode),i&&(this._identifier=i.identifier))},VB_PartBase.prototype.onTouchChange=function(t,e){},VB_PartBase.prototype.onRelease=function(){this.clear()},VB_PartBase.prototype.makeDebugData=function(){if(this._rect){var t=new Bitmap(this._rect.width,this._rect.height);return t.blt(this._bitmap,0,0,t.width,t.height,0,0),{x:this._rect.x,y:this._rect.y,bitmap:t}}return null},VB_PartBase.prototype.reset=function(t,e,i){this._rect&&(this._rect.x=t,this._rect.y=e,this.onWindowResize(),this.setOpacity(i))},VB_PartBase.prototype.isWindowResize=function(){return this._lastScale!==Graphics._realScale||this._lastWindowWidth!==document.body.clientWidth||this._lastWindowHeight!==document.body.clientHeight},VB_PartBase.prototype.onWindowResize=function(){var t=Graphics._canvas.offsetTop,e=Graphics._canvas.offsetLeft;this._lastScale=Graphics._realScale,this._lastWindowWidth=document.body.clientWidth,this._lastWindowHeight=document.body.clientHeight,this._bitmap.canvas.style.top=this._rect.y*this._lastScale+t+"px",this._bitmap.canvas.style.left=this._rect.x*this._lastScale+e+"px",this._bitmap.canvas.style.width=this._rect.width*this._lastScale+"px",this._bitmap.canvas.style.height=this._rect.height*this._lastScale+"px"},VB_PartBase.prototype.update=function(){this._isVisible&&this._bitmap&&this.updateGraphicsScale()},VB_PartBase.prototype.updateGraphicsScale=function(){this.isWindowResize()&&this.onWindowResize()},VB_Rocker.prototype=Object.create(VB_PartBase.prototype),VB_Rocker.prototype.constructor=VB_Rocker,VB_Rocker.prototype.initialize=function(t,e,i){VB_PartBase.prototype.initialize.call(this,t,e,i),this.createBall(),this.setupDirectionKeys(),this.onOpacityChange()},VB_Rocker.prototype.clear=function(){VB_PartBase.prototype.clear.call(this),this._lastDirection=0},VB_Rocker.prototype.setupDirectionKeys=function(){var t=Object.keys(Input.keyMapper),e=["down","left","right","up"].map(function(e){for(var i=0;i<t.length;++i)if(Input.keyMapper[t[i]]===e)return parseInt(t[i]);return 0});this._directionKeys=[[],[e[0],e[1]],[e[0]],[e[0],e[2]],[e[1]],[],[e[2]],[e[1],e[3]],[e[3]],[e[2],e[3]]]},VB_Rocker.prototype.getDirectionKeys=function(t){return this._directionKeys[t]||[]},VB_Rocker.prototype.createBall=function(){if(this._data.ballImg)this._ball=this.createPictureBitmap(this._data.ballImg);else{var t=Math.floor(this._rect.width/3),e=t/2;this._ball=new Bitmap(t,t),this._ball.drawCircleGD(e,e,e,.4,"rgb(0,0,0)","rgb(80,80,80)")}var i=this._ball.canvas;i.id="keyBall",i.style.opacity=this._opacity,i.style.position="absolute",i.style.margin="auto",i.style.zIndex=98,this.ballHoming(),document.body.appendChild(i)},VB_Rocker.prototype.isBallMoved=function(t,e){return this._ballX!==t||this._ballY!==e},VB_Rocker.prototype.setBallPosition=function(t,e,i){if(this._ball&&(i||this.isBallMoved(t,e))){this._ballX=t,this._ballY=e;var a=Graphics._canvas.offsetTop,s=Graphics._canvas.offsetLeft;this._ball.canvas.style.top=e*this._lastScale+a+"px",this._ball.canvas.style.left=t*this._lastScale+s+"px",this._ball.canvas.style.width=this._ball.width*this._lastScale+"px",this._ball.canvas.style.height=this._ball.height*this._lastScale+"px"}},VB_Rocker.prototype.ballHoming=function(){var t=this._rect.width/2-this._ball.width/2;this.setBallPosition(this._rect.x+t,this._rect.y+t)},VB_Rocker.prototype.isVisible=function(){return this._isVisible&&(this._data.isFixed||this._isPressed)},VB_Rocker.prototype.onOpacityChange=function(){if(VB_PartBase.prototype.onOpacityChange.call(this),this._ball){var t=this.isVisible()?this._opacity:0;this._ball.canvas.style.opacity=t}},VB_Rocker.prototype.reactionDistance=function(){return this._rect.width/5},VB_Rocker.prototype.isTouch=function(t,e){return this._data.isFixed?!(!this._isPressed||this._data.ballLimit)||VB_PartBase.prototype.isTouch.call(this,t,e):this._isVisible&&Graphics.isInsideCanvas(t,e)},VB_Rocker.prototype.onTouch=function(t,e,i){if(!this._isPressed&&!VB_Manager.isHoverButton(t,e))if(VB_PartBase.prototype.onTouch.call(this,t,e,i),this._data.isFixed)this.onTouchChange(t,e);else{var a=t-this._rect.width/2,s=e-this._rect.height/2;this.reset(a,s,this._opacity),this.onOpacityChange()}},VB_Rocker.prototype.onTouchChange=function(t,e){VB_PartBase.prototype.onTouchChange.call(this,t,e);var i=this._ball.width/2,a=Math.max(0,Math.min(Graphics.width-2*i,t-i)),s=Math.max(0,Math.min(Graphics.height-2*i,e-i)),o=this._rect.x+this._rect.width/2,n=this._rect.y+this._rect.height/2,r=((Math.PI/2+Math.atan2(e-n,t-o))/Math.PI*180+360)%360,h=Math.abs(t-o)+Math.abs(e-n);if(this._data.ballLimit){var c=Math.floor(this._rect.width/2)-Math.floor(this._ball.width/2)-4;a=o+(h=Math.min(c,h))*Math.sin(r*Math.PI/180)-i,s=n-h*Math.cos(r*Math.PI/180)-i}this.setBallPosition(a,s),h>=this.reactionDistance()?this.refreshTouchDirection(r):(this._lastDirection=0,this.clearPressedKeys())},VB_Rocker.prototype.refreshTouchDirection=function(t){var e=[8,9,6,3,2,1,4,7][Math.max(0,Math.floor((t-22.5)/45+1))%8];if(e&&this._lastDirection!==e){var i=this.getDirectionKeys(e),a=this.getDirectionKeys(this._lastDirection).filter(function(t){return!i.contains(t)});this.keyUp(...a),this.keyDown(...i)}this._lastDirection=e},VB_Rocker.prototype.onRelease=function(){VB_PartBase.prototype.onRelease.call(this),!this._data.isFixed&&this.onOpacityChange(),this.ballHoming()},VB_Rocker.prototype.reset=function(t,e,i){VB_PartBase.prototype.reset.call(this,t,e,i),this.ballHoming()},VB_Rocker.prototype.onWindowResize=function(){VB_PartBase.prototype.onWindowResize.call(this),this.setBallPosition(this._ballX,this._ballY,!0)},VB_Button.prototype=Object.create(VB_PartBase.prototype),VB_Button.prototype.constructor=VB_Button,VB_Button.prototype.initialize=function(t,e,i){this._highlight=!1,VB_PartBase.prototype.initialize.call(this,t,e,i)},VB_Button.prototype.createBitmap=function(){if(VB_PartBase.prototype.createBitmap.call(this),this._bitmap){var t=this._bitmap._context;this._imageData=t.getImageData(0,0,this._rect.width,this._rect.height)}},VB_Button.prototype.closeHighlight=function(){this._highlight&&(this._highlight=!1,this._bitmap.setImageData(this._imageData))},VB_Button.prototype.onTouch=function(t,e,i){VB_PartBase.prototype.onTouch.call(this,t,e,i),!this._highlight&&this._imageData&&(this._highlight=!0,this._bitmap.adjustTone(80,80,80))},VB_Button.prototype.onRelease=function(){VB_PartBase.prototype.onRelease.call(this),this.closeHighlight()},VB_Button.prototype.onOpacityChange=function(){VB_PartBase.prototype.onOpacityChange.call(this),this.closeHighlight()},VB_Button.prototype.makeDebugData=function(){return this.closeHighlight(),VB_PartBase.prototype.makeDebugData.call(this)};var XR_Window_Base_activate=Window_Base.prototype.activate;Window_Base.prototype.activate=function(){XR_Window_Base_activate.call(this),this._vbCount=5};var XR_Window_Base_update=Window_Base.prototype.update;Window_Base.prototype.update=function(){XR_Window_Base_update.call(this),this._vbCount&&this._vbCount--};var XR_Window_Selectable_isOpenAndActive=Window_Selectable.prototype.isOpenAndActive;Window_Selectable.prototype.isOpenAndActive=function(){return!this._vbCount&&XR_Window_Selectable_isOpenAndActive.call(this)};var XR_Window_Options_makeCommandList=Window_Options.prototype.makeCommandList;Window_Options.prototype.makeCommandList=function(){this.addCommand("虚拟按键调整","virtualButton"),XR_Window_Options_makeCommandList.call(this)};var XR_Window_Options_statusText=Window_Options.prototype.statusText;Window_Options.prototype.statusText=function(t){return"virtualButton"===this.commandSymbol(t)?"":XR_Window_Options_statusText.call(this,t)};var XR_Window_Options_processOk=Window_Options.prototype.processOk;Window_Options.prototype.processOk=function(){if("virtualButton"===this.commandSymbol(this.index()))return SoundManager.playOk(),SceneManager.push(Scene_DebugVB);XR_Window_Options_processOk.call(this)};var XR_Window_Options_changeValue=Window_Options.prototype.changeValue;function DebugVB_SpriteBase(){this.initialize.apply(this,arguments)}function DebugVB_Arrow(){this.initialize.apply(this,arguments)}function DebugVB_Button(){this.initialize.apply(this,arguments)}function DebugVB_Keymap(){this.initialize.apply(this,arguments)}function DebugVB_Window(){this.initialize.apply(this,arguments)}function DebugVB_Opacity(){this.initialize.apply(this,arguments)}function Scene_DebugVB(){this.initialize.apply(this,arguments)}Window_Options.prototype.changeValue=function(t,e){"virtualButton"!==t&&XR_Window_Options_changeValue.call(this,t,e)},DebugVB_SpriteBase.prototype=Object.create(Sprite.prototype),DebugVB_SpriteBase.prototype.constructor=DebugVB_SpriteBase,DebugVB_SpriteBase.prototype.initialize=function(){Sprite.prototype.initialize.call(this),this._pressCount=0},DebugVB_SpriteBase.prototype.hitTest=function(t,e){return new Rectangle(-this.anchor.x*this.width,-this.anchor.y*this.height,this.width,this.height).contains(t,e)},DebugVB_SpriteBase.prototype.isTouched=function(){var t=new Point(TouchInput.x,TouchInput.y),e=this.worldTransform.applyInverse(t);return this.hitTest(e.x,e.y)},DebugVB_SpriteBase.prototype.isPressed=function(){return this._pressCount>0},DebugVB_SpriteBase.prototype.isActive=function(){return!(!this.worldVisible||this.isPressed())&&(!this.parent||!this.parent.isActive||this.parent.isActive())},DebugVB_SpriteBase.prototype.onTouch=function(){SoundManager.playOk(),this._pressCount=8,this.scale=new Point(.95,.95)},DebugVB_SpriteBase.prototype.onPressEnd=function(){this._pressCount=0,this.scale=new Point(1,1)},DebugVB_SpriteBase.prototype.update=function(){Sprite.prototype.update.call(this),this.updatePressed(),this.updateTouch()},DebugVB_SpriteBase.prototype.updatePressed=function(){this.isPressed()&&(this._pressCount--,!this._pressCount&&this.onPressEnd())},DebugVB_SpriteBase.prototype.updateTouch=function(){TouchInput.isTriggered()&&this.isActive()&&this.isTouched()&&this.onTouch()},DebugVB_Arrow.prototype=Object.create(DebugVB_SpriteBase.prototype),DebugVB_Arrow.prototype.constructor=DebugVB_Arrow,DebugVB_Arrow.prototype.initialize=function(t,e){DebugVB_SpriteBase.prototype.initialize.call(this),this.anchor=new Point(.5,.5),this.bitmap=new Bitmap(32,32),this.bitmap.drawArrow(0,0,32,32,"white","down"),this.visible=!1,this.move(t,e)},DebugVB_Arrow.prototype.isActive=function(){return this.worldVisible&&!this.isPressed()},DebugVB_Arrow.prototype.onTouch=function(){DebugVB_SpriteBase.prototype.onTouch.call(this),this.parent.onArrowPress()},DebugVB_Button.prototype=Object.create(DebugVB_SpriteBase.prototype),DebugVB_Button.prototype.constructor=DebugVB_Button,DebugVB_Button.prototype.initialize=function(t,e,i,a,s,o){DebugVB_SpriteBase.prototype.initialize.call(this),this.anchor=new Point(.5,.5),this.bitmap=new Bitmap(i,a),this._pressFun=o,this.drawBitmap(s),this.move(t,e)},DebugVB_Button.prototype.drawBitmap=function(t){this.bitmap.fillRoundRect(2,2,this.width-4,this.height-4,5,2,"Black","LightSlateBlue"),this.bitmap.fontSize=this.height/2,this.bitmap.drawText(t,0,0,this.width,this.height,"center")},DebugVB_Button.prototype.onTouch=function(){DebugVB_SpriteBase.prototype.onTouch.call(this),this._pressFun&&this._pressFun()},DebugVB_Keymap.prototype=Object.create(DebugVB_SpriteBase.prototype),DebugVB_Keymap.prototype.constructor=DebugVB_Keymap,DebugVB_Keymap.prototype.initialize=function(t,e,i,a){DebugVB_SpriteBase.prototype.initialize.call(this),this._touchPoint=null,this.opacity=a,this.bitmap=i,this.move(t,e)},DebugVB_Keymap.prototype.isActive=function(){return"place"===this.parent.debugMod()},DebugVB_Keymap.prototype.setOpacity=function(t){this.opacity=255*t},DebugVB_Keymap.prototype.updateTouch=function(){if(this.isActive())if(this._touchPoint)if(TouchInput.isPressed()){var t=TouchInput.x-this._touchPoint.x,e=TouchInput.y-this._touchPoint.y;this.x=Math.max(0,Math.min(Graphics.width-this.width,t)),this.y=Math.max(0,Math.min(Graphics.height-this.height,e))}else this._touchPoint=null;else if(TouchInput.isTriggered()&&this.isTouched()){var i=TouchInput.x-this.x,a=TouchInput.y-this.y;this._touchPoint=new Point(i,a)}},DebugVB_Window.prototype=Object.create(Sprite.prototype),DebugVB_Window.prototype.constructor=DebugVB_Window,DebugVB_Window.prototype.initialize=function(){Sprite.prototype.initialize.call(this),this._isDisplay=!0,this.createBitmap(),this.createParts(),this.x=(Graphics.width-this.width)/2},DebugVB_Window.prototype.createBitmap=function(){this.bitmap=new Bitmap(640,64),this.bitmap.fillRoundRect(4,4,this.width-8,this.height-8,8,4,"Black","LightSlateGray")},DebugVB_Window.prototype.createParts=function(){var t=this;this._opButton=new DebugVB_Button(100,32,160,36,"调整透明度",function(){t._isDisplay=!1,t.parent.changeDebugMod("opacity")}),this._pcButton=new DebugVB_Button(280,32,160,36,"调整位置",function(){t._isDisplay=!1,t.parent.changeDebugMod("place")}),this._okButton=new DebugVB_Button(460,32,100,36,"确定",function(){t.parent.applyDebug()}),this._clButton=new DebugVB_Button(570,32,100,36,"取消",function(){t.parent.popScene()}),this._arrow=new DebugVB_Arrow(this.width/2,this.height+24),this.addChild(this._opButton),this.addChild(this._pcButton),this.addChild(this._okButton),this.addChild(this._clButton),this.addChild(this._arrow)},DebugVB_Window.prototype.isOnPlace=function(){return this.y===(this._isDisplay?0:-64)},DebugVB_Window.prototype.isActive=function(){return this._isDisplay&&this.isOnPlace()},DebugVB_Window.prototype.onArrowPress=function(){this.parent.changeDebugMod("select"),this._isDisplay=!0},DebugVB_Window.prototype.update=function(){Sprite.prototype.update.call(this),this.updateInput(),this.updateDisplay()},DebugVB_Window.prototype.updateInput=function(){this.isActive()&&(Input.isTriggered("escape")||TouchInput.isCancelled())&&(SoundManager.playCancel(),this.parent.popScene())},DebugVB_Window.prototype.updateDisplay=function(){this.isOnPlace()||(this.y+=this._isDisplay?8:-8,this.isOnPlace()&&(this._arrow.visible=!this._isDisplay))},DebugVB_Opacity.prototype=Object.create(Sprite.prototype),DebugVB_Opacity.prototype.constructor=DebugVB_Opacity,DebugVB_Opacity.prototype.initialize=function(t){Sprite.prototype.initialize.call(this),this._opacityRate=t,this.visible=!1,this._touchX=null,this.createBitmap(),this.createParts(),this.drawRateText();var e=(Graphics.width-this.width)/2,i=(Graphics.height-this.height)/2;this.move(e,i)},DebugVB_Opacity.prototype.createBitmap=function(){this.bitmap=new Bitmap(640,64),this.bitmap.fillRoundRect(4,4,this.width-8,this.height-8,8,4,"Black","SlateGray"),this.bitmap.fillRect(40,30,500,4,"Salmon")},DebugVB_Opacity.prototype.createParts=function(){this._cvs=new Sprite,this._piece=new Sprite,this._cvs.bitmap=new Bitmap(this.width,this.height),this._piece.bitmap=new Bitmap(30,30),this._piece.bitmap.drawCircleGD(15,15,15,.4,"Purple","rgb(180,180,180)"),this.setupPiece(),this.addChild(this._cvs),this.addChild(this._piece)},DebugVB_Opacity.prototype.setupPiece=function(){var t=470*this._opacityRate/100+40;this._piece.move(t,17)},DebugVB_Opacity.prototype.opacityRate=function(){return this._opacityRate/100},DebugVB_Opacity.prototype.drawRateText=function(){this._cvs.bitmap.clear();var t=this._opacityRate+"%";this._cvs.bitmap.drawText(t,0,0,620,64,"right")},DebugVB_Opacity.prototype.refreshOpacityRate=function(){this._opacityRate=Math.floor((this._piece.x-40)/470*100),this.drawRateText(),this.parent.refreshKeymapsOpacity()},DebugVB_Opacity.prototype.isTouchPiece=function(){var t=new Point(TouchInput.x,TouchInput.y),e=this._piece.worldTransform.applyInverse(t);return new Rectangle(0,0,30,30).contains(e.x,e.y)},DebugVB_Opacity.prototype.isTouchBar=function(){var t=TouchInput.x,e=TouchInput.y;return!(t<this.x+40||e<this.y+17)&&(t<=this.x+540&&e<=this.y+47)},DebugVB_Opacity.prototype.update=function(){Sprite.prototype.update.call(this),this.worldVisible&&this.updateTouch()},DebugVB_Opacity.prototype.updateTouch=function(){var t=this._piece.x;if(null!==this._touchX)if(TouchInput.isPressed()){var e=TouchInput.x-this._touchX-this.x;this._piece.x=Math.max(40,Math.min(510,e))}else this._touchX=null;else if(TouchInput.isTriggered())if(this.isTouchPiece())this._touchX=TouchInput.x-this._piece.x-this.x;else if(this.isTouchBar()){var i=TouchInput.x-this.x-15;this._piece.x=Math.max(40,Math.min(510,i))}t!==this._piece.x&&this.refreshOpacityRate()},Scene_DebugVB.prototype=Object.create(Scene_Base.prototype),Scene_DebugVB.prototype.constructor=Scene_DebugVB,Scene_DebugVB.prototype.initialize=function(){Scene_Base.prototype.initialize.call(this),this._debugMod="select",this._data=VB_Manager.getDebugData(),this._imgData=VB_Manager.getDebugImgs(),this._dataVisible=VB_Manager._isVisible,VB_Manager.changeVisible(!1)},Scene_DebugVB.prototype.terminate=function(){Scene_Base.prototype.terminate.call(this),VB_Manager.changeVisible(this._dataVisible)},Scene_DebugVB.prototype.create=function(){Scene_Base.prototype.create.call(this),this.createBackground(),this.createKeymaps(),this.createOptWindow(),this.createOpacityWindow()},Scene_DebugVB.prototype.createBackground=function(){var t=Graphics.width,e=Graphics.height,i="rgba(0,0,0,0.5)",a=t/3-1,s=e/3-1;this._background=new Sprite,this._background.bitmap=new Bitmap(t,e),this._background.bitmap.fillAll("rgb(120,120,120)"),this._background.bitmap.fillRect(0,s,t,3,i),this._background.bitmap.fillRect(a,0,3,e,i),this._background.bitmap.fillRect(2*a,0,3,e,i),this._background.bitmap.fillRect(0,2*s,t,3,i),this.addChild(this._background)},Scene_DebugVB.prototype.createKeymaps=function(){var t=this;this._keymaps={};var e=255*this._data.opacity;Object.keys(this._imgData).forEach(function(i){var a=t._imgData[i];t._keymaps[i]=new DebugVB_Keymap(a.x,a.y,a.bitmap,e),t.addChild(t._keymaps[i])})},Scene_DebugVB.prototype.createOptWindow=function(){this._optWindow=new DebugVB_Window,this.addChild(this._optWindow)},Scene_DebugVB.prototype.createOpacityWindow=function(){this._opacityWindow=new DebugVB_Opacity(Math.floor(100*this._data.opacity)),this.addChild(this._opacityWindow)},Scene_DebugVB.prototype.debugMod=function(){return this._debugMod},Scene_DebugVB.prototype.changeDebugMod=function(t){this._debugMod=t,this._opacityWindow.visible="opacity"===t},Scene_DebugVB.prototype.refreshKeymapsOpacity=function(){var t=this,e=this._opacityWindow.opacityRate();Object.keys(this._keymaps).forEach(function(i){t._keymaps[i].setOpacity(e)})},Scene_DebugVB.prototype.applyDebug=function(){var t=this;this._data.opacity=this._opacityWindow.opacityRate(),Object.keys(this._keymaps).forEach(function(e){var i=t._keymaps[e],a=new Point(i.x,i.y);t._data.buttons[e]=a}),VB_Manager.resetSaveData(this._data),this.popScene()},reineXdRs_VirtualButtons.VB_Manager=VB_Manager}("MZ"===Utils.RPGMAKER_NAME));
